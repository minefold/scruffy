#!/usr/bin/env ruby
# encoding: UTF-8
require 'bundler/setup'
Bundler.require :default

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'scruffy'

STDOUT.sync = true

Bugsnag.configure do |config|
  config.api_key = ENV['BUGSNAG']
  config.release_stage = Scruffy.env
  config.project_root = Scruffy.root
  config.notify_release_stages = ['production', 'staging']
  config.use_ssl = true
end


loop do
  cluster = if Scruffy.env == 'development'
    LocalCluster.new
  else
    FogCluster.new
  end

  boxes = Boxes.new(cluster)
  pinkies = Pinkies.new(RedisBus.new)
  scruffy = Scruffy.new(RedisBus.new, boxes, pinkies)

  scruffy.sweep!
  scruffy.report

  sleep 5
end
